version: "3.9"
services:
  configurator:
    depends_on:
      - mongodb
      - kafka-0
      - kafka-1
      - kafka-2
      - temporal
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: .
      dockerfile: ./apps/configurator/Dockerfile
    expose:
      - 8080
    ports:
      - 9000:8080
    environment:
      - NODE_ENV=prod
      - PORT=8080
      - DB_TYPE=mongodb
      - DB_URI=${DB_URI}
      - BROKER_TYPE=kafka
      - BROKER_URIS=${BROKER_URIS}
      - KAFKA_CLIENT_ID=configurator
      - KAFKA_CONSUMER_GROUP_ID=configurator-consumer
      - KAFKA_SSL_ENABLED=false
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS}
      - ORCHESTRATOR_WORKER_TASKQUEUE=configurator
      - ORCHESTRATOR_DEFAULT_TASKQUEUE=configurator
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
  controller:
    depends_on:
      - mongodb
      - kafka-0
      - kafka-1
      - kafka-2
      - temporal
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: .
      dockerfile: ./apps/controller/Dockerfile
    expose:
      - 8080
    ports:
      - 9001:8080
    environment:
      - NODE_ENV=prod
      - PORT=8080
      - DB_TYPE=mongodb
      - DB_URI=${DB_URI}
      - BROKER_TYPE=kafka
      - BROKER_URIS=${BROKER_URIS}
      - KAFKA_CLIENT_ID=controller
      - KAFKA_CONSUMER_GROUP_ID=controller-consumer
      - KAFKA_SSL_ENABLED=false
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS}
      - ORCHESTRATOR_WORKER_TASKQUEUE=controller
      - ORCHESTRATOR_DEFAULT_TASKQUEUE=controller
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
  worker:
    depends_on:
      - mongodb
      - kafka-0
      - kafka-1
      - kafka-2
      - temporal
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: .
      dockerfile: ./apps/worker/Dockerfile
    expose:
      - 8080
    ports:
      - 9003:8080
    environment:
      - NODE_ENV=prod
      - PORT=9000
      - DB_TYPE=mongodb
      - DB_URI=${DB_URI}
      - BROKER_TYPE=kafka
      - BROKER_URIS=${BROKER_URIS}
      - KAFKA_CLIENT_ID=worker
      - KAFKA_CONSUMER_GROUP_ID=worker-consumer
      - KAFKA_SSL_ENABLED=false
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS}
      - ORCHESTRATOR_WORKER_TASKQUEUE=worker
      - ORCHESTRATOR_DEFAULT_TASKQUEUE=worker
      - DOWNLOADER_URL=${DOWNLOADER_URL}
      - COMPARER_URL=${COMPARER_URL}
      - LOADER_URL=${LOADER_URL}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
  post-processor:
    depends_on:
      - mongodb
      - kafka-0
      - kafka-1
      - kafka-2
      - temporal
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: .
      dockerfile: ./apps/post-processor/Dockerfile
    expose:
      - 8080
    ports:
      - 9004:8080
    environment:
      - NODE_ENV=prod
      - PORT=9000
      - DB_TYPE=mongodb
      - DB_URI=${DB_URI}
      - BROKER_TYPE=kafka
      - BROKER_URIS=${BROKER_URIS}
      - KAFKA_CLIENT_ID=post-processor
      - KAFKA_CONSUMER_GROUP_ID=post-processor-consumer
      - KAFKA_SSL_ENABLED=false
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS}
      - ORCHESTRATOR_WORKER_TASKQUEUE=post-processor
      - ORCHESTRATOR_DEFAULT_TASKQUEUE=post-processor
  #--------------------------------- PROCESSORS --------------------------------------#
  downloader:
    depends_on:
      - minio
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: ./apps/processors/downloader
      dockerfile: Dockerfile
    expose:
      - 8080
    ports:
      - 8000:8080
    environment:
      - PORT=8080
      - PRODUCTION=true
      - S3_URL=${S3_URL}
      - S3_REGION=${S3_REGION}
      - S3_DIFF_DATA_BUCKET=${S3_DIFF_DATA_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
  comparer:
    depends_on:
      - minio
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: ./apps/processors/comparer
      dockerfile: Dockerfile
    expose:
      - 8080
    ports:
      - 8001:8080
    environment:
      - PORT=8080
      - PRODUCTION=true
      - S3_URL=${S3_URL}
      - S3_REGION=${S3_REGION}
      - S3_DIFF_DATA_BUCKET=${S3_DIFF_DATA_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
  loader:
    depends_on:
      - minio
      - postgresql
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: ./apps/processors/loader
      dockerfile: Dockerfile
    expose:
      - 8080
    ports:
      - 8002:8080
    environment:
      - PORT=8080
      - PRODUCTION=true
      - S3_URL=${S3_URL}
      - S3_REGION=${S3_REGION}
      - S3_DIFF_DATA_BUCKET=${S3_DIFF_DATA_BUCKET}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - DB_TYPE=postgres
      - DB_HOST=${DEST_DB_HOST}
      - DB_PORT=${DEST_DB_PORT}
      - DB_USER=${DEST_DB_USER}
      - DB_PASSWORD=${DEST_DB_PASSWORD}
      - DB_NAME=${DEST_DB_NAME}
      - DB_SSL_MODE=disable
  #--------------------------------- TRIGGERS --------------------------------------#
  cron-trigger:
    depends_on:
      - mongodb
      - kafka-0
      - kafka-1
      - kafka-2
      - temporal
    deploy:
      restart_policy:
        condition: on-failure
        delay: 3s
    build:
      context: .
      dockerfile: ./apps/triggers/cron/Dockerfile
    expose:
      - 8080
    ports:
      - 8003:8080
    environment:
      - NODE_ENV=prod
      - PORT=8080
      - DB_TYPE=mongodb
      - DB_URI=${DB_URI}
      - BROKER_TYPE=kafka
      - BROKER_URIS=${BROKER_URIS}
      - KAFKA_CLIENT_ID=cron-trigger
      - KAFKA_CONSUMER_GROUP_ID=cron-trigger
      - KAFKA_SSL_ENABLED=false
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS}
      - ORCHESTRATOR_WORKER_TASKQUEUE=cron-trigger
      - ORCHESTRATOR_DEFAULT_TASKQUEUE=cron-trigger
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      #--------------------------------- DATABASE ---------------------------------------#

      # mongodb:
      # restart: on-failure
      # build:
      # context: .
      # dockerfile: ./init/mongodb.Dockerfile
      # expose:
      # - 27017
      # ports:
      # - 27017:27017
      # volumes:
      # - mongodb:/data/db
      # healthcheck:
      # test: test $$(echo "rs.initiate().ok || rs.status().ok" | mongo -u admin -p abc123456 --quiet) -eq 1
      # interval: 10s
      # start_period: 30s
      # environment:
      # - MONGO_INITDB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      # - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      # - MONGO_INITDB_DATABASE=${MONGODB_DATABASE_NAME}
  mongodb:
    restart: on-failure
    image: bitnami/mongodb:5.0
    platform: linux/amd64
    ports:
      - 27017:27017
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongodb
      - MONGODB_ROOT_USER=${MONGODB_ROOT_USERNAME}
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_DATABASE=${MONGODB_DATABASE_NAME}
      - MONGODB_REPLICA_SET_MODE=primary
      - MONGODB_REPLICA_SET_KEY=${MONGODB_REPLICASET_NAME}
    volumes:
      - mongodb:/bitnami/mongodb
  postgresql:
    restart: on-failure
    image: bitnami/postgresql:15-debian-11
    ports:
      - 5432:5432
    volumes:
      - postgresql:/bitnami/postgresql
    environment:
      - POSTGRESQL_USERNAME=${POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE_NAME}
  #--------------------------------- KAFKA ---------------------------------------#
  kafka-0:
    image: docker.io/bitnami/kafka:3.5.1-debian-11-r1
    ports:
      - 9094:9094
    environment:
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093
      - KAFKA_KRAFT_CLUSTER_ID=abcdefghijklmnopqrstuv
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=${KAFKA_DEFAULT_REPLICATION_FACTOR}
      - KAFKA_CFG_OFFETS_TOPIC_REPLICATION_FACTOR=${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      - KAFKA_CFG_NUM_PARTITIONS=${KAFKA_NUM_PARTITIONS}
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    volumes:
      - kafka_0:/bitnami/kafka
  kafka-1:
    image: docker.io/bitnami/kafka:3.5.1-debian-11-r1
    ports:
      - 9092
    environment:
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093
      - KAFKA_KRAFT_CLUSTER_ID=abcdefghijklmnopqrstuv
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=${KAFKA_DEFAULT_REPLICATION_FACTOR}
      - KAFKA_CFG_OFFETS_TOPIC_REPLICATION_FACTOR=${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      - KAFKA_CFG_NUM_PARTITIONS=${KAFKA_NUM_PARTITIONS}
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    volumes:
      - kafka_1:/bitnami/kafka
  kafka-2:
    image: docker.io/bitnami/kafka:3.5.1-debian-11-r1
    ports:
      - 9092
    environment:
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093
      - KAFKA_KRAFT_CLUSTER_ID=abcdefghijklmnopqrstuv
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092,EXTERNAL://localhost:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=${KAFKA_DEFAULT_REPLICATION_FACTOR}
      - KAFKA_CFG_OFFETS_TOPIC_REPLICATION_FACTOR=${KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR}
      - KAFKA_CFG_NUM_PARTITIONS=${KAFKA_NUM_PARTITIONS}
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    volumes:
      - kafka_2:/bitnami/kafka
  kafka-ui:
    depends_on:
      - kafka-0
      - kafka-1
      - kafka-2
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    ports:
      - 3000:8080
    volumes:
      - ./init/kui-config.prod.yml:/etc/kafkaui/dynamic_config.yaml
    environment:
      DYNAMIC_CONFIG_ENABLED: true
  #----------------------------------- REDIS ----------------------------------------#
  redis:
    restart: on-failure
    image: bitnami/redis:6.2.13-debian-11-r13
    ports:
      - 6379:${REDIS_PORT}
    volumes:
      - redis:/bitnami/redis/data
    environment:
      - REDIS_PORT_NUMBER=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
  #--------------------------------- ORCHESTRATOR (TEMPORAL) ---------------------------------------#
  temporal:
    restart: on-failure
    depends_on:
      - postgresql
    image: temporalio/auto-setup:1.20.3.2
    expose:
      - 7233
    ports:
      - 7233:7233
    labels:
      kompose.volume.type: configMap
    volumes:
      - ./init/temporal-config.prod.yml:/etc/temporal/config/dynamicconfig/development-sql.yaml
    environment:
      - DB=${TEMPORAL_DB}
      - DB_PORT=${TEMPORAL_DB_PORT}
      - POSTGRES_USER=${TEMPORAL_POSTGRES_USER}
      - POSTGRES_PWD=${TEMPORAL_POSTGRES_PWD}
      - POSTGRES_SEEDS=${TEMPORAL_POSTGRES_SEEDS}
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
  #--------------------------------- MINIO ---------------------------------------#
  minio:
    restart: on-failure
    image: bitnami/minio:2023.7.18-debian-11-r2
    ports:
      - 3002:9001
    volumes:
      - minio:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_DEFAULT_BUCKETS=${MINIO_DEFAULT_BUCKETS}
volumes:
  mongodb:
    driver: local
  redis:
    driver: local
  kafka_0:
    driver: local
  kafka_1:
    driver: local
  kafka_2:
    driver: local
  postgresql:
    driver: local
  minio:
    driver: local
  pgadmin:
    driver: local
